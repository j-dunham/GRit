#!/usr/bin/env ruby
# frozen_string_literal: true

require 'digest'
require 'zlib'
require 'fileutils'
require_relative '../lib/grit/object'

unless Dir.exist? GRit::GRIT_DIRECTORY
  warn 'Not an GRit project'
  exit 1
end

path = ARGV.first

if path.nil?
  warn 'No path specified'
  exit 1
end

file_contents = File.read path
sha = Digest::SHA1.hexdigest file_contents
blob = Zlib::Deflate.deflate file_contents
object_directory = "#{GRit::OBJECTS_DIRECTORY}/#{sha[0..1]}"
FileUtils.mkdir_p object_directory
blob_path = "#{object_directory}/#{sha[2..-1]}"

File.open(blob_path, 'w') do |file|
  file.print blob
end

File.open(GRit::INDEX_PATH, 'a') do |file|
  file.puts "#{sha} #{path}"
end
